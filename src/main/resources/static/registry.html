<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Brutopia</title>
    <link href="css/brutopia.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="row d-flex bg-light-info align-items-center justify-content-center h-100 w-100">
        <div class="col-md-4 col-sm-9 card">
            <div class="pb-0 card-header">
                <h1>Cadastro</h1>
            </div>
            <hr class="mx-3 my-2">
            <form>
                <div class="pt-1 card-body d-flex flex-column">
                    <div class="form-group">
                        <label for="name">Nome</label>
                        <input type="text" class="form-control" id="name" placeholder="Insira o seu nome">
                        <div class="valid-feedback">Tudo certo!</div>
                        <div id="nameFeedback" class="invalid-feedback">O seu nome deve possuir entre 4 a 32 caracteres!</div>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="text" class="form-control" id="email" placeholder="Insira o seu email">
                        <div class="valid-feedback">Tudo certo!</div>
                        <div id="emailFeedback" class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="password">Senha</label>
                        <input type="text" class="form-control" id="password" placeholder="Insira a sua senha">
                        <div class="valid-feedback">Tudo certo!</div>
                        <div id="passwordFeedback" class="invalid-feedback">Sua senha deve possuir entre 8 a 32 caracteres!</div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirmar senha</label>
                        <input type="text" class="form-control" id="confirmPassword" placeholder="Insira novamente a sua senha">
                        <div class="valid-feedback">Tudo certo!</div>
                        <div id="confirmPasswordFeedback" class="invalid-feedback">Ambas as senhas devem coincidir!</div>
                    </div>
                    <button id="submitButton" type="button" class="btn btn-success mt-2 align-self-center">Criar conta</button>
                    <hr>
                    <h4 class="align-self-center">Já possui uma conta?</h4>
                    <button id="toLoginButton" type="button" class="btn btn-success mt-2 align-self-center">Fazer login</button>
                </div>
            </form>
        </div>
    </div>
    <script src="js/brutopia.js"></script>
    <script>
        //Event listeners, responsáveis por verificar se as informações foram inseridas corretamentes
        var eventListenerInputs = {
            name(input) {
                if(input.value.length < 4 || input.value.length > 32) {
                    input.classList.add("is-invalid");
                }
                else {
                    input.classList.add("is-valid")
                }
            },
            email(input) {
                fetch(`api/accounts/email-used?email=${input.value}`)
                    .then(async (response) => {
                        var isUsedEmail;
                        isUsedEmail = await response.json()

                        if(!input.value.match("^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$")) {
                            document.getElementById("emailFeedback").innerHTML = "Insira um email válido!"
                            input.classList.add("is-invalid");
                        }
                        else if(isUsedEmail) {
                            document.getElementById("emailFeedback").innerHTML = "O email já está sendo utilizado!"
                            input.classList.add("is-invalid");
                        }
                        else {
                            input.classList.add("is-valid")
                        }
                    })
            },
            password(input) {
                if(input.value.length < 8 || input.value.length > 32) {
                    input.classList.add("is-invalid");
                }
                else {
                    input.classList.add("is-valid")
                }
            },
            confirmPassword(input) {

                let password = document.getElementById("password").value

                if(password !== input.value || password.length < 1) {
                    input.classList.add("is-invalid");
                }
                else {
                    input.classList.add("is-valid")
                }
            }
        }

        //Insere os event listeners nos inputs
        document.querySelectorAll("input").forEach(input => {
            input.addEventListener("focus", () => {
                input.classList.remove("is-invalid")
                input.classList.remove("is-valid")
            })
            input.addEventListener("blur", () => { eventListenerInputs[input.id](input) })
        })

        //Reponsável por fazer uma request de registro a API, ao clicar o botão
        document.getElementById("submitButton").addEventListener("click", () => {
            var name = document.getElementById("name").value
            var email = document.getElementById("email").value
            var password = document.getElementById("password").value
            var confirmPassword = document.getElementById("confirmPassword").value

            var formData = {
                name,
                email,
                password,
                confirmPassword
            }

            fetch("api/accounts/registry", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formData)
            })
            .then(async (response) => {
                console.log(await response.json())
            })
            .catch((err) => {
                console.log(err)
            })
        })

        //Responsável por trocar a tela de registro para a tela de login
        document.getElementById("toLoginButton").addEventListener("click", () => { window.location.href = window.location.href.replace("registry", "login")})
    </script>
</body>
</html>